
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition template="/template/templateGeral.xhtml"
	xmlns="http://www.w3.org/1999/xhtml"
	xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
	xmlns:f="http://xmlns.jcp.org/jsf/core"
	xmlns:h="http://xmlns.jcp.org/jsf/html"
	xmlns:p="http://primefaces.org/ui">

	<f:metadata>
		<f:viewAction action="#{ordemServicoBean.carregarDados()}" />
	</f:metadata>

	<ui:define name="title_page">Ordens de Serviço</ui:define>

	<ui:define name="conteudo">
		<div style="width: 600xp; background-color: #cccccc">
			<h:form id="frmOrdemPesquisa">
				<p:growl autoUpdate="true" showDetail="true" showSummary="false" />
				<p:panel id="painelPrincipal">
					<p:inputText placeholder="apenas o numero"
						value="#{ordemServicoBean.txtPesquisa}"
						rendered="#{not ordemServicoBean.pesquisaAvancada}"
						style="margin-right:10px;" id="txtPesquisa">
					</p:inputText>

					<p:commandButton
						rendered="#{not ordemServicoBean.pesquisaAvancada}"
						value="Pesquisar" action="#{ordemServicoBean.chamaPesquisa}"
						update=":frmOrdemTabela, txtPesquisa " />

					<p:selectBooleanButton offLabel="(+)Filtros"
						style="margin-bottom:5px;" onLabel="(-)Filtros"
						value="#{ordemServicoBean.pesquisaAvancada}">
						<p:ajax update=":frmOrdemPesquisa" />
					</p:selectBooleanButton>

					<p:panelGrid columns="4" styleClass="filtrosPesquisa" id="avancada"
						rendered="#{ordemServicoBean.pesquisaAvancada}">
						<p:outputLabel value="Componente" for="filtroComponente" />
						<p:inputText value="#{ordemServicoBean.filtros.componente}"
							id="filtroComponente" size="16" />

						<p:outputLabel value="Ciclo Preventivo" for="filtroCiclo" />
						<p:inputText value="#{ordemServicoBean.filtros.ciclo}"
							id="filtroCiclo" size="16">
							<f:convertNumber integerOnly="true" maxIntegerDigits="4" />
						</p:inputText>

						<p:outputLabel value="Status" for="filtroStatus" />
						<p:selectOneMenu value="#{ordemServicoBean.filtros.status}"
							id="filtroStatus" style="width:165px">
							<f:selectItem itemLabel="selecione" noSelectionOption="true" />
							<f:selectItems value="#{ordemServicoBean.statusOrdem()}"
								var="item" itemLabel="#{item}" itemValue="#{item}" />
						</p:selectOneMenu>

						<p:outputLabel value="Centro de Trabalho" for="filtroSetor" />
						<p:selectOneMenu value="#{ordemServicoBean.filtros.setor}"
							id="filtroSetor" style="width:165px;">
							<f:selectItem itemLabel="selecione" noSelectionOption="true" />
							<f:selectItems value="#{ordemServicoBean.departamentos}"
								var="item" itemLabel="#{item.nome}" itemValue="#{item}" />
						</p:selectOneMenu>

						<p:outputLabel value="Tipo de Trabalho" for="filtroTipo" />
						<p:selectOneMenu value="#{ordemServicoBean.filtros.tipoTrabalho}"
							id="filtroTipo" style="width:165px;">
							<f:selectItem itemLabel="selecione" noSelectionOption="true" />
							<f:selectItems value="#{ordemServicoBean.tiposTrabalho()}"
								var="item" itemLabel="#{item}" itemValue="#{item}" />
						</p:selectOneMenu>

						<p:outputLabel value="Tipo de Ordem" for="filtroOrdem" />
						<p:selectOneMenu value="#{ordemServicoBean.filtros.tipoOrdem}"
							id="filtroOrdem" style="width:165px;">
							<f:selectItem itemLabel="selecione" noSelectionOption="true" />
							<f:selectItems value="#{ordemServicoBean.tipoDeOrdem()}"
								var="item" itemLabel="#{item}" itemValue="#{item}" />
						</p:selectOneMenu>
					</p:panelGrid>
					<p:panelGrid columns="4" id="gridFiltroDatas"
						rendered="#{ordemServicoBean.pesquisaAvancada}">
						<p:outputLabel value="DE" />
						<p:inputMask mask="99/99/9999"
							value="#{ordemServicoBean.filtros.dataInicio}">

							<f:convertDateTime pattern="dd/MM/yyyy" />
						</p:inputMask>

						<p:outputLabel value="ATÉ" />
						<p:inputMask mask="99/99/9999"
							value="#{ordemServicoBean.filtros.dataFinal}">
							<f:convertDateTime pattern="dd/MM/yyyy" />
						</p:inputMask>
					</p:panelGrid>
					<f:facet name="footer">
						<p:commandButton id="btnPesquisa"
							action="#{ordemServicoBean.pesquisar()}" style="margin-top:5px"
							value="pesquisar" rendered="#{ordemServicoBean.pesquisaAvancada}"
							update=":frmOrdemTabela, :frmOrdemPesquisa" />
					</f:facet>
				</p:panel>
			</h:form>

			<h:form id="frmOrdemTabela">
				<p:panel id="painelOrdem">
					<p:dataTable value="#{ordemServicoBean.ordensDeServico}"
						var="ordem" rows="5" paginator="true" id="tabelaDeOrdem">

						<p:column headerText="ID" style="width:90px;text-align:center">
							<span class="txtLabel">#{ordem.tipoOrdem == 'CORRETIVA' ?
								'OSN' : 'OSP'}#{ordem.id}</span>
						</p:column>

						<p:column headerText="Equipamento"
							style="width:100px;text-align:center">
							<span class="txtValor">#{ordem.equipamento}</span>
						</p:column>

						<p:column headerText="Componente"
							style="width:150px;text-align:center">
							<span class="txtValor">#{ordem.componente}</span>
						</p:column>

						<p:column headerText="Descrição">
							<span class="txtValor">#{ordem.descricaoAcao}</span>
						</p:column>

						<p:column headerText="Setor" style="width:100px;text-align:center"
							rendered="#{facesContext.externalContext.isUserInRole('planejamento')}">
							<span class="txtValor">#{ordem.setor.nome}</span>
						</p:column>

						<p:column headerText="T.Trabalho"
							style="width:90px;text-align:center">
							<span class="txtValor">#{ordem.tipoTrabalho}</span>
						</p:column>

						<p:column headerText="Status" style="width:95px;text-align:center"
							styleClass="#{ordem.status}">
							<span class="txtValor">#{ordem.status}</span>
						</p:column>
						<p:column style="width:60px;">
							<p:commandLink
								actionListener="#{ordemServicoBean.programarExecutor}"
								update=":frmOrdemDialog">
								<p:graphicImage url="/images/lupaview.png" title="ver detalhes" />
								<f:setPropertyActionListener value="#{ordem}"
									target="#{ordemServicoBean.ordemSelecionada}" />
							</p:commandLink>
							<p:spacer width="15px" />
							<h:commandButton action="#{ordemServicoBean.gerarOrdem}"
								onclick="this.form.target='_blank'" image="/images/imprimir.png"
								rendered="#{ordem.status != 'ABERTO' and not facesContext.externalContext.isUserInRole('supervisao')}">
								<f:setPropertyActionListener value="#{ordem}"
									target="#{ordemServicoBean.ordemSelecionada}" />
							</h:commandButton>
						</p:column>
					</p:dataTable>
				</p:panel>
			</h:form>
		</div>
		<h:form id="frmOrdemDialog">

			<p:panel id="detalhes" rendered="#{ordemServicoBean.programarOs}">
				<p:panelGrid columns="2" columnClasses="txtLabel, txtValor">
					<p:outputLabel value="Ordem: " />
					<h:outputText
						value="#{ordemServicoBean.ordemSelecionada.tipoOrdem}" />

					<p:outputLabel value="Status: " />
					<h:outputText value="#{ordemServicoBean.ordemSelecionada.status}" />

					<p:outputLabel value="Data de criação:" />
					<h:outputText
						value="#{ordemServicoBean.ordemSelecionada.dataCriacao}">
						<f:convertDateTime pattern="dd/MM/yyyy" />
					</h:outputText>

					<p:outputLabel value="Equipamento: " />
					<h:outputText
						value="#{ordemServicoBean.ordemSelecionada.equipamento}" />

					<p:outputLabel value="Componente: " />
					<h:outputText
						value="#{ordemServicoBean.ordemSelecionada.componente}" />

					<p:outputLabel value="Em funcionamento: " />
					<h:outputText
						value="#{ordemServicoBean.ordemSelecionada.emFuncionamento ? 'SIM' : 'NÃO'}" />

					<p:outputLabel value="Departamento: " />
					<h:outputText
						value="#{ordemServicoBean.ordemSelecionada.setor.nome}" />

					<p:outputLabel value="Ação:" />
					<h:outputText
						value="#{ordemServicoBean.ordemSelecionada.descricaoAcao}" />

				</p:panelGrid>

				<p:panelGrid columns="2" columnClasses="txtLabel, txtValor"
					rendered="#{ordemServicoBean.ordemSelecionada.status == 'ENCERRADO'}">

					<p:outputLabel value="Solução" />
					<h:outputText
						value="#{ordemServicoBean.ordemSelecionada.descricaoSolucao}" />

					<p:outputLabel value="Data de criação:" />
					<h:outputText
						value="#{ordemServicoBean.ordemSelecionada.dataCriacao}">
						<f:convertDateTime pattern="dd/MM/yyyy" />
					</h:outputText>

					<p:outputLabel value="INSERIR DADOS DE CONFIRMACAO AKKI " />

					<p:outputLabel value="Observação: " />
					<h:outputText
						value="#{ordemServicoBean.ordemSelecionada.observacao}" />
				</p:panelGrid>

				<p:panel style="width:500px;"
					rendered="#{ordemServicoBean.ordemSelecionada.status == 'CONFIRMADO'}">
					<p:dataTable
						value="#{ordemServicoBean.ordemSelecionada.colaboradores}"
						var="colab">
						<f:facet name="header">
			            Executores
			           </f:facet>
						<p:column style="width:80px">
							<f:facet name="header">Matric</f:facet>
			           	#{colab.matricula} 
			           </p:column>
						<p:column>
							<f:facet name="header">Nome</f:facet>
			           	#{colab.nome} #{colab.sobrenome}
			           </p:column>
					</p:dataTable>
				</p:panel>

				<f:facet name="footer">
					<p:commandButton value="Programar" update="modalPrograma"
						oncomplete="PF('dlg').show()"
						rendered="#{not facesContext.externalContext.isUserInRole('supervisao') and ordemServicoBean.ordemSelecionada.status == 'ABERTO'}" />
					<p:commandButton value="Mudar para Andamento"
						rendered="#{ordemServicoBean.ordemSelecionada.status == 'IMPRESSO' and not facesContext.externalContext.isUserInRole('supervisao')}" />

					<p:commandButton value="Imprimir"
						action="#{ordemServicoBean.gerarOrdem}"
						onclick="this.form.target='_blank'" ajax="false"
						rendered="#{ordemServicoBean.ordemSelecionada.status == 'PROGRAMADO' and not facesContext.externalContext.isUserInRole('supervisao')}" />

					<p:commandButton value="Confirmar"
						actionListener="#{ordemServicoBean.popularExecutores}"
						rendered="#{ordemServicoBean.ordemSelecionada.status == 'ANDAMENTO' and ordemServicoBean.ordemSelecionada.setor == ordemServicoBean.osService.colaboradorLogado().setor
						or ordemServicoBean.ordemSelecionada.status == 'ANDAMENTO' and facesContext.externalContext.isUserInRole('planejamento')}"
						oncomplete="PF('encerrarDlg').show()" />
				</f:facet>

				<p:dialog widgetVar="dlg" modal="true" id="modalPrograma"
					closable="true" resizable="false" appendToBody="true">
					<p:panelGrid columns="2">
						<p:outputLabel value="Tempo estimado para Conclusão" />
						<p:spinner
							value="#{ordemServicoBean.ordemSelecionada.prazoParaOrdem}"
							min="0" placeholder="em minutos" />
						<f:facet name="footer">
							<p:commandButton value="Programar"
								action="#{ordemServicoBean.programa}"
								update=":frmOrdemDialog, :frmOrdemTabela"
								onclick="PF('dlg').hide()" />
						</f:facet>
					</p:panelGrid>
				</p:dialog>
			</p:panel>
		</h:form>
		<p:dialog widgetVar="encerrarDlg" modal="true" id="modalEncerra"
			width="600px" closable="true" resizable="false" appendToBody="false"
			header="Dados de confirmação">

			<h:form id="frmConfirmaDatas" prependId="false">

				<p:panelGrid columns="4" id="gridConfirma">
					<p:outputLabel value="Inicio" />
					<h:panelGroup>
						<p:inputMask mask="99/99/9999"
							value="#{ordemServicoBean.confirmacao.dataInicio}" id="dataIni"
							required="true" requiredMessage="Campo Obrigatorio">
							<f:convertDateTime pattern="dd/MM/yyy" />
						</p:inputMask>
						<p:message for="dataIni" />
					</h:panelGroup>

					<p:outputLabel value="Hora" />

					<h:panelGroup>
						<p:inputMask mask="99:99"
							value="#{ordemServicoBean.confirmacao.horaInicio}" id="horaIni"
							required="true" requiredMessage="Campo Obrigatorio">
							<f:convertDateTime pattern="HH:mm" />
						</p:inputMask>
						<p:message for="horaIni" />
					</h:panelGroup>

					<p:outputLabel value="Final" />

					<h:panelGroup>
						<p:inputMask mask="99/99/9999"
							value="#{ordemServicoBean.confirmacao.dataFim}" id="dataFim"
							required="true" requiredMessage="Campo Obrigatorio">
							<f:convertDateTime pattern="dd/MM/yyy" />
						</p:inputMask>
						<p:message for="dataFim" />
					</h:panelGroup>

					<p:outputLabel value="Hora" />

					<h:panelGroup>
						<p:inputMask mask="99:99"
							value="#{ordemServicoBean.confirmacao.horaFim}" id="horaFim"
							required="true" requiredMessage="Campo Obrigatorio">
							<f:convertDateTime pattern="HH:mm" />
						</p:inputMask>
						<p:message for="horaFim" />
					</h:panelGroup>

					<p:outputLabel value="Executor" />

					<p:selectOneMenu
						value="#{ordemServicoBean.confirmacao.colaborador}"
						required="true" requiredMessage="Escolha o Executor">
						<f:selectItem itemLabel="Selecione" noSelectionOption="true" />
						<f:selectItems value="#{ordemServicoBean.filtroColaborador}"
							var="co" itemLabel="#{co.nome}" itemValue="#{co}" />
					</p:selectOneMenu>


					<f:facet name="footer">
						<p:graphicImage url="/images/mais.png" />
						<p:commandLink value="Add Confirmação" update="frmConfirmaDatas"
							action="#{ordemServicoBean.addNovaLinhaConfirmacao}" />
					</f:facet>
				</p:panelGrid>
				<p:dataTable value="#{ordemServicoBean.confirmacoes}" var="conf" rendered="#{not empty ordemServicoBean.confirmacoes}" id="tabelaConfirma">
					<p:column headerText="data inicio" style="text-align:center">
						<p:outputLabel value="#{conf.dataInicio}">
							<f:convertDateTime pattern="dd/MM/yyyy"/>
						</p:outputLabel>
					</p:column>
					
					<p:column headerText="hora" style="text-align:center">
						<p:outputLabel value="#{conf.horaInicio}">
							<f:convertDateTime pattern="HH:mm"/>
						</p:outputLabel>
					</p:column>
					
					<p:column headerText="data final" style="text-align:center">
						<p:outputLabel value="#{conf.dataFim}">
							<f:convertDateTime pattern="dd/MM/yyyy"/>
						</p:outputLabel>
					</p:column>
					
					<p:column headerText="hora" style="text-align:center">
						<p:outputLabel value="#{conf.horaFim}">
							<f:convertDateTime pattern="HH:mm"/>
						</p:outputLabel>
					</p:column>
				</p:dataTable>
			</h:form>

			<h:form id="frmConfirmacao">
			
				<p:outputLabel styleClass="txtLabel" value="Texto de confirmação" style="margin-bottom:10px;" />
					<p:inputTextarea
						value="#{ordemServicoBean.ordemSelecionada.descricaoSolucao}"
						cols="50" rows="5" style="margin-bottom:10px;" required="true"
						requiredMessage="Favor informar o texto de confirmação" />
					<br />
					<p:commandButton value="Confirmar" action="#{ordemServicoBean.executarConfirmacao}" update=":frmOrdemTabela, :frmConfirmacao"/>
					<p:commandButton value="Cancelar" action="#{ordemServicoBean.cancelar}" immediate="true" oncomplete="PF('encerrarDlg').hide()"/>

			</h:form>
		</p:dialog>

	</ui:define>
</ui:composition>