<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition template="/template/templateGeral.xhtml"
	xmlns="http://www.w3.org/1999/xhtml"
	xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
	xmlns:f="http://xmlns.jcp.org/jsf/core"
	xmlns:h="http://xmlns.jcp.org/jsf/html"
	xmlns:p="http://primefaces.org/ui">

	<f:metadata>
		<f:viewAction action="#{ordemServicoBean.carregarDados()}" />
	</f:metadata>

	<ui:define name="title_page">Ordens de Serviço</ui:define>

	<ui:define name="conteudo">
		<div style="width: 600xp; background-color: #cccccc">
			<h:form id="frmOrdemPesquisa">
				<p:growl autoUpdate="true" showDetail="true" showSummary="false" />
				<p:panel id="painelPrincipal">
					<p:inputText placeholder="apenas o numero"
						value="#{ordemServicoBean.txtPesquisa}"
						rendered="#{not ordemServicoBean.pesquisaAvancada}"
						style="margin-right:10px;" id="txtPesquisa">
					</p:inputText>

					<p:commandButton
						rendered="#{not ordemServicoBean.pesquisaAvancada}"
						value="Pesquisar" action="#{ordemServicoBean.chamaPesquisa}"
						update=":frmOrdemTabela, txtPesquisa " />

					<p:selectBooleanButton offLabel="(+)Filtros"
						style="margin-bottom:5px;" onLabel="(-)Filtros"
						value="#{ordemServicoBean.pesquisaAvancada}">
						<p:ajax update=":frmOrdemPesquisa" />
					</p:selectBooleanButton>

					<p:panelGrid columns="4" styleClass="filtrosPesquisa" id="avancada"
						rendered="#{ordemServicoBean.pesquisaAvancada}">
						<p:outputLabel value="Componente" for="filtroComponente" />
						<p:inputText value="#{ordemServicoBean.filtros.componente}"
							id="filtroComponente" size="16" />

						<p:outputLabel value="Ciclo Preventivo" for="filtroCiclo" />
						<p:inputText value="#{ordemServicoBean.filtros.ciclo}"
							id="filtroCiclo" size="16">
							<f:convertNumber integerOnly="true" maxIntegerDigits="4" />
						</p:inputText>

						<p:outputLabel value="Status" for="filtroStatus" />
						<p:selectOneMenu value="#{ordemServicoBean.filtros.status}"
							id="filtroStatus" style="width:165px">
							<f:selectItem itemLabel="selecione" noSelectionOption="true" />
							<f:selectItems value="#{ordemServicoBean.statusOrdem()}"
								var="item" itemLabel="#{item}" itemValue="#{item}" />
						</p:selectOneMenu>

						<p:outputLabel value="Centro de Trabalho" for="filtroSetor" />
						<p:selectOneMenu value="#{ordemServicoBean.filtros.setor}"
							id="filtroSetor" style="width:165px;">
							<f:selectItem itemLabel="selecione" noSelectionOption="true" />
							<f:selectItems value="#{ordemServicoBean.departamentos}"
								var="item" itemLabel="#{item.nome}" itemValue="#{item}" />
						</p:selectOneMenu>

						<p:outputLabel value="Tipo de Trabalho" for="filtroTipo" />
						<p:selectOneMenu value="#{ordemServicoBean.filtros.tipoTrabalho}"
							id="filtroTipo" style="width:165px;">
							<f:selectItem itemLabel="selecione" noSelectionOption="true" />
							<f:selectItems value="#{ordemServicoBean.tiposTrabalho()}"
								var="item" itemLabel="#{item}" itemValue="#{item}" />
						</p:selectOneMenu>

						<p:outputLabel value="Tipo de Ordem" for="filtroOrdem" />
						<p:selectOneMenu value="#{ordemServicoBean.filtros.tipoOrdem}"
							id="filtroOrdem" style="width:165px;">
							<f:selectItem itemLabel="selecione" noSelectionOption="true" />
							<f:selectItems value="#{ordemServicoBean.tipoDeOrdem()}"
								var="item" itemLabel="#{item}" itemValue="#{item}" />
						</p:selectOneMenu>
					</p:panelGrid>
					<p:panelGrid columns="4" id="gridFiltroDatas"
						rendered="#{ordemServicoBean.pesquisaAvancada}">
						<p:outputLabel value="DE" />
						<p:inputMask mask="99/99/9999"
							value="#{ordemServicoBean.filtros.dataInicio}">

							<f:convertDateTime pattern="dd/MM/yyyy" />
						</p:inputMask>

						<p:outputLabel value="ATÉ" />
						<p:inputMask mask="99/99/9999"
							value="#{ordemServicoBean.filtros.dataFinal}">
							<f:convertDateTime pattern="dd/MM/yyyy" />
						</p:inputMask>
					</p:panelGrid>
					<f:facet name="footer">
						<p:commandButton id="btnPesquisa"
							action="#{ordemServicoBean.pesquisar()}" style="margin-top:5px"
							value="pesquisar" rendered="#{ordemServicoBean.pesquisaAvancada}"
							update=":frmOrdemTabela, :frmOrdemPesquisa" />
					</f:facet>
				</p:panel>
			</h:form>

			<h:form id="frmOrdemTabela">
				<p:panel id="painelOrdem">
					<p:dataTable value="#{ordemServicoBean.ordensDeServico}"
						var="ordem" rows="5" paginator="true" id="tabelaDeOrdem">

						<p:column headerText="ID" style="width:100px;text-align:center">
							<span class="txtLabel">#{ordem.tipoOrdem == 'CORRETIVA' ? 'OSN' : 'OSP'}#{ordem.id}</span>
						</p:column>

						<p:column headerText="Equipamento"
							style="width:100px;text-align:center">
							<span class="txtValor">#{ordem.equipamento}</span>
						</p:column>

						<p:column headerText="Componente"
							style="width:150px;text-align:center">
							<span class="txtValor">#{ordem.componente}</span>
						</p:column>

						<p:column headerText="Descrição">
							<span class="txtValor">#{ordem.descricaoAcao}</span>
						</p:column>

						<p:column headerText="Setor" style="width:100px;text-align:center"
							rendered="#{facesContext.externalContext.isUserInRole('planejamento')}">
							<span class="txtValor">#{ordem.setor.nome}</span>
						</p:column>

						<p:column headerText="Tipo Trabalho"
							style="width:120px;text-align:center">
							<span class="txtValor">#{ordem.tipoTrabalho}</span>
						</p:column>

						<p:column headerText="Status" style="width:95px;text-align:center"
							styleClass="#{ordem.status}">
							<span class="txtValor">#{ordem.status}</span>
						</p:column>
						<p:column style="width:60px;">
							<p:commandLink actionListener="#{ordemServicoBean.programarExecutor}" update=":frmOrdemDialog">
								<p:graphicImage url="/images/lupaview.png" title="ver detalhes" />
								<f:setPropertyActionListener value="#{ordem}"
									target="#{ordemServicoBean.ordemSelecionada}" />
							</p:commandLink>
							<p:spacer width="15px" />
							<p:commandLink action="#{ordemServicoBean.gerarOrdem()}" onclick="this.form.target='_blank'">
								<p:graphicImage url="/images/imprimir.png" title="ver detalhes"
									rendered="#{ordem.status == 'ABERTO'}" />
							</p:commandLink>

						</p:column>
					</p:dataTable>
				</p:panel>
			</h:form>
		</div>
		<h:form id="frmOrdemDialog">

			<p:panel id="detalhes" rendered="#{ordemServicoBean.programarOs}" >
				<p:panelGrid columns="2" columnClasses="txtLabel, txtValor"  style="float:left">
					<p:outputLabel value="Ordem: " />
					<h:outputText
						value="#{ordemServicoBean.ordemSelecionada.tipoOrdem}" />

					<p:outputLabel value="Status: " />
					<h:outputText value="#{ordemServicoBean.ordemSelecionada.status}" />

					<p:outputLabel value="Data de criação:" />
					<h:outputText
						value="#{ordemServicoBean.ordemSelecionada.dataCriacao}">
						<f:convertDateTime pattern="dd/MM/yyyy" />
					</h:outputText>

					<p:outputLabel value="Equipamento: " />
					<h:outputText
						value="#{ordemServicoBean.ordemSelecionada.equipamento}" />

					<p:outputLabel value="Componente: " />
					<h:outputText
						value="#{ordemServicoBean.ordemSelecionada.componente}" />

					<p:outputLabel value="Em funcionamento: " />
					<h:outputText
						value="#{ordemServicoBean.ordemSelecionada.emFuncionamento ? 'SIM' : 'NÃO'}" />

					<p:outputLabel value="Departamento: " />
					<h:outputText
						value="#{ordemServicoBean.ordemSelecionada.setor.nome}" />

					<p:outputLabel value="Ação:" />
					<h:outputText
						value="#{ordemServicoBean.ordemSelecionada.descricaoAcao}" />

				</p:panelGrid>

				<p:panelGrid columns="2" columnClasses="txtLabel, txtValor" style="float:left"
					rendered="#{ordemServicoBean.ordemSelecionada.status == 'ENCERRADO'}">

					<p:outputLabel value="Solução" />
					<h:outputText
						value="#{ordemServicoBean.ordemSelecionada.descricaoSolucao}" />

					<p:outputLabel value="Data de criação:" />
					<h:outputText
						value="#{ordemServicoBean.ordemSelecionada.dataCriacao}">
						<f:convertDateTime pattern="dd/MM/yyyy" />
					</h:outputText>

					<p:outputLabel value="Iniciado em: " />
					<h:outputText
						value="#{ordemServicoBean.ordemSelecionada.dataInicio}">
						<f:convertDateTime pattern="dd/MM/yyyy" />
					</h:outputText>

					<p:outputLabel value="Hora: " />
					<h:outputText
						value="#{ordemServicoBean.ordemSelecionada.horaInicio}">
						<f:convertDateTime pattern="hh:mm:ss" />
					</h:outputText>

					<p:outputLabel value="Finalizado em: " />
					<h:outputText
						value="#{ordemServicoBean.ordemSelecionada.dataFinal}">
						<f:convertDateTime pattern="dd/MM/yyyy" />
					</h:outputText>

					<p:outputLabel value="Hora: " />
					<h:outputText
						value="#{ordemServicoBean.ordemSelecionada.horaFinal}">
						<f:convertDateTime pattern="hh:mm:ss" />
					</h:outputText>

					<p:outputLabel value="Observação: " />
					<h:outputText
						value="#{ordemServicoBean.ordemSelecionada.observacao}" />
					</p:panelGrid>
					
					<p:panel style="float:left;width:300px;">
						<span class="txtLabel">Executores</span>
						<ui:repeat var="colab" value="#{ordemServicoBean.ordemSelecionada.colaboradores}">
							<li>#{colab.nome}</li>
						</ui:repeat>
						
					</p:panel>
					
					<div class="clear"></div>
				<f:facet name="footer">
					<p:commandButton value="Programar" update="modelPrograma" oncomplete="PF('dlg').show()"
						rendered="#{ordemServicoBean.ordemSelecionada.status == 'ABERTO'}" />
					<p:commandButton value="Mudar para Andamento" 
						rendered="#{ordemServicoBean.ordemSelecionada.status == 'IMPRESSO'}" />
					<h:commandButton value="Imprimir" action="#{ordemServicoBean.gerarOrdem()}" onclick="this.form.target='_blank'" 
						rendered="#{ordemServicoBean.ordemSelecionada.status == 'PROGRAMADO'}" />
					<p:commandButton value="Encerrrar Tecnicamente"
						rendered="#{ordemServicoBean.ordemSelecionada.status == 'ANDAMENTO'}"
						style="background-color:red;" />
				</f:facet>
				
				<p:dialog widgetVar="dlg" id="modelPrograma" modal="true" closeOnEscape="true" resizable="false">
					<p:panelGrid columns="2" id="panelprograma">
						
						<p:outputLabel value="Executor(s)"/>
						<p:selectManyMenu value="#{ordemServicoBean.executores}" filterMatchMode="contains" showCheckbox="true" filter="true" scrollHeight="72" converter="com.locar.pipe.Colab">
							<f:selectItems value="#{ordemServicoBean.filtroColaborador}" var="colaborador" itemLabel="#{colaborador.nome}" itemValue="#{colaborador}"/>
						</p:selectManyMenu>
						
						<p:outputLabel value="Prazo( em horas )"/>
						<p:spinner value="#{ordemServicoBean.ordemSelecionada.prazoParaOrdem}" stepFactor="1" min="0" />
						
						<f:facet name="footer">
							<p:commandButton value="Salvar" action="#{ordemServicoBean.programa}" update=":frmOrdemDialog, :frmOrdemTabela" oncomplete="PF('dlg').hide()">
								
							</p:commandButton>
							
							<p:commandButton value="Imprimir">
								
							</p:commandButton>
							
							<p:commandButton value="Cancelar" resetValues="true" update="modelPrograma" oncomplete="PF('dlg').hide()">
								
							</p:commandButton>
						</f:facet>
					</p:panelGrid>
					
				</p:dialog>
			</p:panel>
		</h:form>
	</ui:define>
</ui:composition>